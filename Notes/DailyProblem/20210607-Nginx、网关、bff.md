# gateway和nginx网关的区别

网关可以看作系统与外界联通的入口，可以在网关进行处理一些非业务逻辑的逻辑，比如权限验证，监控，缓存，请求路由等。

+ gateway是**前端工程** 到 **后台服务器**的一个对内网关
+ nginx是**用户** 到 **前端工程**的网关，是对外网关
+ nginx是抗连接+负载均衡的， 网关用于业务出口服务

# 网关、bff演变

Backend For Frontend（服务于前端的后端）

网关和 BFF（Backend for Frontend）是微服务架构中的两个重要的角色。我们先看一个公司的构架演进历史。（携程进化历程）

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-ed923405295c95dc-1623027762919.png)

第一阶段

第一阶段这种调用直接用ngnix直接暴露，是有一定问题的。

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-0318e1d15719dac4-1623030277056.png)

第二阶段

v2架构问题

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-f2f0e69773807f01-1623030327678.png)

第二阶段暴露的还有无限APP端还有聚合裁剪+逻辑适配的问题，就是说需要同时调用多个后端的接口，结果进行聚合，要显示产品分类和细节，就必须要调用2次接口，不能一次完成。裁剪针对的是页面窗口的大小，手机和平板显示的不同就需要去除一些东西。还有消息格式的适配，有xml、json各种。

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-d9de68fa3d7381a7-1623030385301.png)

加入bff的架构

bff是前端人员开发的后端服务。代理适配。bff架构有自己的优点，也有缺点。

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-47319ff198d41aa4-1623030401755.png)

bff优点

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-5d2f17b541fa236f.png)

bff缺点

针对上述bff的缺点，演变出来网关和bff集群。

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-5344a87dec37f94b-1623030436009.png)

bff+网关

网关是解耦拆分的关键。这种跨横切面的功能的抽离，使得bff的开发也可以分业务流水线，提供效率。

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-c297b786d95b2b05-1623030448623.png)

网关的好处

最后的一个架构，逐渐废弃了nginx这种不可编辑的反向代理的功能（这部分跟网关重叠），全部由可编程的网关代替。

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-206017d4b73db533-1623030463179.png)

v4架构

总结

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/16903744-951673b8718e6f3c-1623030478703.png)

总结

1、网关也是微服务吗？

网关是构建微服务基础设施的一个核心组件，网关部署以后也可以说对外提供服务(反向路由，安全认证，日志监控等)，它属于技术基础服务，但不属于业务服务。

2、网关 、openresty或者kong、Nginx之间的关系？

kong可以认为是专门针对API网关场景的升级版的Nginx，openresty是对Nginx的一种扩展，kong其实也是基于openrest扩展的。Nginx历史悠久，成熟稳定，应用场景丰富。这些产品总体是互补的，不能简单理解为替代关系。Openresty/kong都属于可编程网关。

3、服务分层具体是怎么理解的？

服务分层一般按照职能划分：微服务层：提供基础业务和技术服务；BFF:聚合裁剪适配服务，面向各种端用户体验(PC, mobile, 第三方接入等)；网关层：负责反向路由，安全，监控等跨横切面功能。

实际每一层和具体协议没有严格对应关系，微服务可以用rpc，也可以http/rest，BFF和网关也可以支持rpc或者http/rest。当然，微服务用dubbo rpc框架，BFF转成http/rest，网关再暴露http，也是一种架构方式。

4、BFF 现在流行的说法是FaaS，网关可以由是 servless 方式实现，弱化 devOps？

BFF有很多玩法，之前看到过用动态脚本(可在运行时上传动态运行)做BFF，也有尝试用GraphQL做BFF，FaaS/serless做BFF还没有怎么听说，可能是一种新的尝试，anyway，BFF目标是帮助前端快速迭代。

5、是不是应该在bff与微服务层之间再加一个网关层?如何发现服务？

 BFF层可以直接调微服务，走基于注册中心的服务发现即可。如果在BFF和微服务之间再加一层网关(或者nginx反向代理)，相当于集中式负载均衡+反向路由，也不是不可以，只是性能损耗会变大，而且维护成本会变高。

比较典型的微服务分层方式：外部client -> 网关GW -> BFF -> Microservices。GW如何发现BFF？BFF如何发现Microservices？这个可以借助注册中心，例如Eureka。如果在k8s环境中，可以不需要注册中心，因为k8s平台本身就支持服务发现。

BFF是聚合服务层，是介于后台基础服务和外部端设备之间的一层，也能算中台的一部分，但只能算偏前端的一小部分。

6、使用nginx作为服务入口，后端微服务为什么还需要很多域名呢，如果只暴露Nginx的ip，那么内部服务也不会暴露在公网上？

在v2版本中，nginx可以只暴露统一ip和域名，然后根据请求path或者参数再转发到后台服务，这样nginx就相当于是一个网关。但再互联网研发早期，很多公司没有把nginx当网关用，运维通常规定所有对外暴露服务必须独立申请公网域名。

# bff

- 什么是 BFF
- BFF 解决了什么问题
- 使用 BFF 的正确姿势
- 实战中的玩法

## 什么是 BFF

BFF，即 Backend For Frontend（服务于前端的后端），也就是服务器设计 API 时会考虑前端的使用，并在服务端直接进行业务逻辑的处理，又称为用户体验适配器。BFF 只是一种逻辑分层，而非一种技术，虽然 BFF 是一个新名词，但它的理念由来已久。

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/3100944-f5d383cf1d142e29-1623030124144.png)

## BFF 解决了什么问题

如下图，在我们的前端页面时常存在，某个页面需要向 backend A、backend B 以及 backend C...... 发送请求，不同服务的返回值用于渲染页面中不同的 component，即一个页面存在很多请求的场景。

此时，每次访问该页面都需要发送 3 个请求。同时为了保障 Android，iOS，以及 Web 端的不同需求，需要为不同的平台写不同的 API 接口，而每当值发生一些变化时，需要 Android，iOS，Web 做出修改。与此同时，当我们需要对一个字符串进行处理，如限定 140 个字符的时候，我们需要在每一个客户端（Android，iOS，Web）分别实现一遍，这样的代价显然相当大。

于是，我们就需要 BFF 作为中间件。在这个中间件上我们将做一些业务逻辑处理：

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/3100944-80ac3d90822f1053-1623030168181.png)

而当我们有了 BFF 这一层时，我们就不需要考虑系统后端的迁移。后端发生的变化都可以在 BFF 层做一些响应的修改。

例如，我们加入 BFF 层，原本每次访问发送 3 请求页面，变成一个请求。

![img](Nginx%E3%80%81%E7%BD%91%E5%85%B3%E3%80%81bff.assets/3100944-0fd3db877ff651a5-1623030191360.png)

## 使用 BFF 的正确姿势

- 多端应用
   我们在设计 API 时会考虑到不同设备的需求，也就是为不同的设备提供不同的 API，虽然它们可能是实现相同的功能，但因为不同设备的特殊性，它们对服务端的 API 访问也各有其特点，需要区别处理。
- 服务聚合
   随着微服务的兴起，原本在同一个进程内运行的业务流程被拆分到了不同的服务中。这在增加业务灵活性的同时，也让前端的调用变得更复杂。BFF 的出现为前端应用提供了一个对业务服务调用的聚合点，它屏蔽了复杂的服务调用链，让前端可以聚焦在所需要的数据上，而不用关注底层提供这些数据的服务。
- 非必要，莫新增
   我们在看到 BFF 带来的各种好处的同时，也要注意到它所带来的代码重复和工作量增加方面的问题。如果与已有 BFF 功能类似，且展现数据的要求也相近的话，一定要谨慎对待新增 BFF 的行为。因此，建议**非必要，莫新增**。

## 实战中的玩法

- 访问控制
   例如，服务中的权限控制，将所有服务中的权限控制集中在 BFF 层，使下层服务更加纯粹和独立。
- 应用缓存
   项目中时常存在一些需要缓存的临时数据，此时 BFF 作为业务的汇聚点，距离用户请求最近，遂将该缓存操作放在 BFF 层。
- 第三方入口
   在业务中需要与第三交互时，将该交互放在 BFF 层，这样可以只暴露必要信息给第三方，从而便于控制第三方的访问。